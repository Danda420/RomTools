#!/bin/bash

img=$(realpath $1)
partition=$2
TOOLSDIR=$PWD
RUNDIR=$(dirname $1)
mount="$TOOLSDIR/$partition"
bin="$TOOLSDIR/bin"
tmpdir="$TOOLSDIR/tmp"
fscontexts="$tmpdir/plat_file_contexts"


mount() {
    sudo rm -rf $tmpdir $mount
    mkdir $mount
    echo "- Mounting $partition..."
    sudo mount -t auto -o ro,nosuid,nodev,relatime,uhelper=udisks2,loop $img $mount > /dev/null 2>&1 
}

fs_contexts() {
        echo "/cust(/.*)?                    u:object_r:rootfs:s0" >> "$fscontexts"
        echo "/my_bigball(/.*)?                    u:object_r:rootfs:s0" >> "$fscontexts"
        echo "/my_carrier(/.*)?                    u:object_r:rootfs:s0" >> "$fscontexts"
        echo "/my_custom(/.*)?                    u:object_r:rootfs:s0" >> "$fscontexts"
        echo "/my_company(/.*)?                    u:object_r:rootfs:s0" >> "$fscontexts"
        echo "/my_engineering(/.*)?                u:object_r:rootfs:s0" >> "$fscontexts"
        echo "/my_heytap(/.*)?                     u:object_r:rootfs:s0" >> "$fscontexts"
        echo "/my_manifest(/.*)?                   u:object_r:rootfs:s0" >> "$fscontexts"
        echo "/my_preload(/.*)?                    u:object_r:rootfs:s0" >> "$fscontexts"
        echo "/my_product(/.*)?                    u:object_r:rootfs:s0" >> "$fscontexts"
        echo "/my_region(/.*)?                     u:object_r:rootfs:s0" >> "$fscontexts"
        echo "/my_stock(/.*)?                      u:object_r:rootfs:s0" >> "$fscontexts"
        echo "/my_version(/.*)?                    u:object_r:rootfs:s0" >> "$fscontexts"
        echo "/my_reserve(/.*)?                    u:object_r:rootfs:s0" >> "$fscontexts"
        if [[ $partition != "system" ]] && [[ $(blkid -o value -s TYPE $img) == erofs ]] ; then
            mkdir $TOOLDIR/system
            sudo mount -t auto $RUNDIR/system.img $TOOLDIR/system
            sudo cat $TOOLDIR/system/system/etc/selinux/plat_file_contexts >> $fscontexts
            sudo umount -f -l $TOOLDIR/system
            rm -rf $TOOLDIR/system
        elif [[ $partition != "system" ]]; then
            mkdir $TOOLDIR/system
            sudo mount -t auto -o ro,nosuid,nodev,relatime,uhelper=udisks2,loop $RUNDIR/system.img $TOOLDIR/system
            sudo cat $TOOLDIR/system/system/etc/selinux/plat_file_contexts >> $fscontexts
            sudo umount -f -l $TOOLDIR/system
            rm -rf $TOOLDIR/system
    	elif [[ $partition == "system" ]]; then
            sudo cat $mount/system/etc/selinux/plat_file_contexts >> $fscontexts
    	fi
    	if [[ $partition == "system_ext" ]]; then
            sudo cat $mount/etc/selinux/system_ext_file_contexts >> $fscontexts
    	fi
    	if [[ $partition == "vendor" ]]; then
    	    sudo cat $mount/etc/selinux/vendor_file_contexts >> $fscontexts
    	fi
}

rebuild() {
    mkdir $tmpdir
    echo "- Rebuilding $partition..."
    fs_contexts
    SIZE=`sudo du -sk $mount | awk '{$1*=1024;$1=int($1*2);printf $1}'`
    if (( $SIZE < 1474560 )); then
        SIZE=`sudo du -sk $mount | awk '{$1*=1024;$1=int($1*7);printf $1}'`
    fi
    sudo $bin/mkuserimg_mke2fs.py "$mount/" "$partition.img" ext4 "/$partition" $SIZE $fscontexts -j "0" -T "1230768000" -L "$partition" -I "256" -M "/$partition" -m "0" > /dev/null 2>&1
    sudo umount -f -l $mount
    rm -rf $mount
    sudo rm -rf $tmpdir
    echo "- Done!"
}

mount
rebuild
exit
