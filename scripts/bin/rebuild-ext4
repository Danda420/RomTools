#!/bin/bash

img=$(realpath $1)
partition=$2
TOOLSDIR=$PWD
RUNDIR=$(dirname $1)
extracted_dir="$TOOLSDIR/ext4"
bin="$TOOLSDIR/bin"
tmpdir="$TOOLSDIR/tmp"

extract_ext4() {
   mkdir $extracted_dir
   echo "- Extracting $partition"
   sudo $bin/imgextractor.py $img $extracted_dir > /dev/null 2>&1 
}
rebuild() {
    echo "- Rebuilding $partition..."
    foldersize=$(sudo du -s -B1 $extracted_dir/$partition | awk '{print $1}')
    SIZE=$(($foldersize + $foldersize * 1/10))
    if (( $SIZE < 1474560 )); then
        SIZE=`sudo du -sk $extracted_dir/$partition | awk '{$1*=1024;$1=int($1*8);printf $1}'`
    fi
    sudo $bin/make_ext4fs -J -T -1 -S "$extracted_dir/config/$partition/${partition}_file_contexts" -C "$extracted_dir/config/$partition/${partition}_fs_config" -l "$SIZE" -L "$partition" -a "/$partition" "$partition.img" "$extracted_dir/$partition" > /dev/null 2>&1
    rm -rf $extracted_dir
    echo "- Done!"
}

extract_ext4
rebuild
exit
