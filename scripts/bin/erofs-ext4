#!/bin/bash
img=$(realpath $1)
partition=$2
TOOLDIR=$PWD
RUNDIR=$(dirname $1)
erofsdir=$TOOLDIR/erofs
extracted_dir=$erofsdir/$partition
bin=$TOOLDIR/bin
fscontexts=$TOOLDIR/erofs/config/${partition}_file_contexts

unpack_erofs() {
    echo "- Unpacking $partition image (erofs)"
    $bin/erofs.unpack $img $erofsdir > /dev/null 2>&1 
    sed -i "s#/${partition}[(][/][\].*[)]?#/${partition}(/.*)?#g" $fscontexts
    if [[ $partition == system ]]; then
    	cat $extracted_dir/system/etc/selinux/plat_file_contexts > $fscontexts
    	cat $bin/other_file_contexts >> $fscontexts
    fi
}

rebuild_ext4() {
    echo "- Rebuilding $partition as ext4 image..."
    foldersize=$(du -s -B1 $extracted_dir | awk '{print $1}')
    SIZE=$(($foldersize + $foldersize * 1/10))
    if (( $SIZE < 1474560 )); then
        SIZE=`sudo du -sk $extracted_dir | awk '{$1*=1024;$1=int($1*8);printf $1}'`
    fi
    if [[ $partition == "system" ]]; then
        sudo $bin/mkuserimg_mke2fs.py "$extracted_dir/" "$partition.img" ext4 "/" $SIZE $fscontexts -j "0" -T "1230768000" -L "/" -I "256" -M "/" --reserved_percent "0" > /dev/null 2>&1 
    else
        sudo $bin/mkuserimg_mke2fs.py "$extracted_dir/" "$partition.img" ext4 "/$partition" $SIZE $fscontexts -j "0" -T "1230768000" -L "$partition" -I "256" -M "/$partition" --reserved_percent "0" > /dev/null 2>&1 
    fi
    rm -rf $erofsdir
    echo "- Done"
}

unpack_erofs
rebuild_ext4
exit
